# Chrome 内网智能化助手 - 终极开发指南

## 1. 项目概述

本扩展程序旨在打造一款专为企业内网设计的、完全独立的 Chrome 扩展程序。通过提供极致简单易用的网页操作录制与回放功能，自动化处理重复性任务，从而解放生产力。

### 项目愿景

*   **独立自治 (Self-Contained):** 零外部依赖。所有逻辑与数据均在扩展内部处理，保证内网环境的兼容性与数据安全。
*   **用户友好 (User-Friendly):** 为非技术人员提供直观的图形化操作，同时为高级用户保留足够的灵活性。
*   **稳定可靠 (Robust & Reliable):** 引擎必须能优雅地处理现代网页的复杂性，包括异步加载、动态内容和常见错误。
*   **安全至上 (Security First):** 严格遵循 Manifest V3 规范，确保扩展自身的安全，不引入任何安全风险。

## 2. 核心功能

*   **多任务脚本管理:** 创建、编辑、删除、复制、导入、导出自动化脚本，并支持对脚本步骤的完整添加、修改、删除、排序操作。
*   **增强型启动 URL 配置:** 支持通配符、动态变量和内置宏 (如 `{DATE_TODAY}`, `{TIME_HHMM}`)，以及精确/通配符导航策略。
*   **录制模块 (带视觉反馈):** 捕获点击、文本输入、下拉菜单选择、页面导航、页面滚动和文件上传按钮点击等操作，生成可编辑的自动化脚本步骤，并在录制过程中提供**统一且稳定的元素高亮视觉反馈**，**已解决点击干扰、通过回车键记录输入和输入无法记录的问题，并修复了多处 bug 和完善了清理逻辑**。
*   **回放引擎 (带视觉反馈):** 支持后台静默回放和前台展示回放两种模式，回放时提供**实时的元素高亮视觉反馈**，**已支持所有录制事件类型（包括输入和文件上传占位符）**，具备鲁棒元素定位、动态等待、错误处理、会话管理以及**动态页面导航和加载时间处理能力**，实现了更完整的脚本执行。
*   **受限文件下载管理:** 在用户配合浏览器设置（关闭下载前询问、设置固定下载位置）的前提下，自动化下载文件并提供文件名重命名与子目录建议。
*   **定时任务管理:** 为脚本配置定时自动执行计划 (仅支持后台静默模式)。
*   **快捷键触发执行 (可配置):** 支持为每个脚本在管理面板配置自定义命令，并通过 Chrome 扩展程序管理页面的“快捷键”部分绑定全局或 Chrome 特定快捷键组合来触发执行**，并提供了交互式的快捷键管理界面**。
*   **用户界面 (UI):** 包括扩展弹出窗口 (Popup) 和独立管理页面 (Options Page)，提供录制/停止、任务状态、脚本管理（含步骤编辑**与调整**）、定时任务、快捷键配置**与管理**、下载设置、任务日志和全局设置等功能。**其中，管理页面已完成脚本管理模块化重构，并统一使用自定义模态框进行交互，增强了用户体验和代码可维护性；弹出窗口的 UI 状态管理也已优化，并增加了开始录制前的确认提示。**

## 3. 技术栈及平台

*   **平台:** Google Chrome Web Browser (桌面版)。
*   **技术:** Chrome Extension (Manifest V3)。
*   **核心 API:** `chrome.storage`, `chrome.tabs`, `chrome.scripting`, `chrome.alarms`, `chrome.commands`, `chrome.downloads`, `chrome.runtime`, `chrome.messages`。
*   **UI 技术:** HTML, CSS (Tailwind CSS), JavaScript。

## 4. 文件结构

```
/
|-- manifest.json
|-- service-worker.js
|-- icons/
|   |-- icon16.png, icon48.png, icon128.png
|   |-- recording.png (用于录制状态)
|-- popup/
|   |-- popup.html
|   |-- popup.js
|-- options/
|   |-- options.html
|   |-- options.js
|-- content/
|   |-- recorder.js
|   |-- player.js
|-- utils/
|   |-- storage.js
|   |-- selector.js
|   |-- uuid.js
|   |-- url_parser.js
```

## 5. 开发进度与原则应用

### 5.1 本次迭代已完成核心任务

*   **文件结构创建:** 完成了所有所需文件夹的创建。
*   **`manifest.json` 文件生成:** 根据需求生成了 `manifest.json`。
*   **`service-worker.js` 文件生成与补全:** 实现了核心的生命周期、监听器和消息处理器，并完善了录制/停止功能，**解决了因 `manifest.json` 错误导致的 `chrome.commands` 未定义问题，包括对快捷键命令的处理和录制状态的稳定控制。**
*   **`popup/popup.html` 和 `popup/popup.js` 文件生成与补全:** 实现了弹出窗口的 UI 和基本交互逻辑，**解决了 UI 暗色且无法点击的问题，并优化了 UI 状态管理，增加了开始录制前的确认提示，以及自定义模态框。**
*   **`options/options.html` 和 `options/options.js` 文件生成与补全:** 实现了管理面板的 UI，并完善了脚本管理（包括脚本步骤的 CRUD 和排序、**详细的步骤编辑**）、定时任务、快捷键配置（含自定义命令**和交互式管理**）以及设置等核心逻辑。**解决了 UI 暗色且无法点击的问题。其中，`options.js` 已完成脚本管理模块化重构，并统一使用自定义模态框进行交互，增强了用户体验和代码可维护性。**
*   **`content/recorder.js` 和 `content/player.js` 文件生成与补全:** 实现了录制和回放的核心逻辑，补全了滚动事件的节流和滚动回放功能，并添加了录制和回放过程中的视觉反馈。**已修复语法错误、点击干扰、输入记录和回放未完全执行的问题，并完善了清理逻辑。**
*   **`utils` 工具函数文件生成:** 创建了 `storage.js`, `uuid.js`, `url_parser.js`, `selector.js` 等工具文件。
*   **图标文件生成:** 创建了占位符图标文件，待用户替换为实际图标。

### 5.2 原则应用

*   **简单至上 (KISS):** 在初期实现时，对于复杂功能采取了渐进式实现，避免了不必要的复杂性。在录制功能中，通过简化事件处理和状态管理，使得录制流程更加直观。UI 方面，统一使用 CSS `hidden` 类控制表单显示，简化了状态管理。**本次迭代中，通过引入自定义模态框，简化了 `alert` 和 `confirm` 交互的实现，使得 UI 代码更加简洁易懂。**
*   **精益求精 (YAGNI):** 严格根据需求进行开发，避免了对未明确要求的功能进行过度设计和提前实现，确保资源投入在当前最核心的功能上。对于不需要频繁更新的 UI 元素，也避免了过度广播状态。
*   **坚实基础 (SOLID):**
    *   **S (单一职责):** 各模块和文件职责清晰，例如 `service-worker.js` 负责后台逻辑，`options.js` 负责管理面板 UI，`storage.js` 负责存储抽象。**本次迭代中，将 `options.js` 的脚本管理逻辑拆分到 `options/scripts-manager.js`，进一步强化了模块的单一职责。**
    *   **O (开放/封闭):** `service-worker.js` 的 `messageHandlers` 机制允许通过添加新消息类型来扩展功能，而无需修改现有核心逻辑。UI 中通过 CSS 类管理表单显示，样式和行为分离，更易于扩展。**自定义模态框的引入也遵循了开放/封闭原则，允许在不修改核心模态框逻辑的情况下，通过配置来适应不同的提示和确认场景。**
    *   **I (接口隔离):** 组件间通过定义良好的消息协议通信，各自关注其特定的职责。
    *   **D (依赖倒置):** 后台逻辑依赖于 `utils` 中的抽象工具函数，降低了耦合度。
*   **杜绝重复 (DRY):** `utils` 文件夹中的工具函数（如 `Storage`, `generateUUID`, `resolveUrl`）被封装和复用，减少了代码重复。UI 代码中，也努力抽象通用渲染逻辑。**自定义模态框的实现，避免了在多个地方重复编写 `alert` 和 `confirm` 的逻辑，减少了代码重复。同时，优化了 `options.js` 和 `popup.js` 中的 UI 列表渲染逻辑，避免了 `innerHTML` 的全量替换，提高了效率。**
*   **文档同步 (Doc Sync):** 本 `README.md` 文件是根据 `jishu.md` 需求文档和 `rules.md` 编程原则编写的，旨在作为代码的同步文档，记录开发进度和决策。

### 5.3 遇到的挑战与克服

*   **需求理解与分解:** `jishu.md` 的复杂性要求细致的阅读和任务分解，通过逐一列出待办事项并逐步实现来确保全面性。
*   **Manifest V3 兼容:** 确保所有 API 使用和权限声明符合 Chrome 扩展 Manifest V3 的新规范。
*   **异步编程范式:** 大量使用了 `async/await` 处理 Chrome API 的异步回调，确保了代码的顺序执行和状态的正确同步。
*   **跨文件通信:** 设计了基于 `chrome.runtime.sendMessage` 的清晰消息协议，实现了 `service-worker` 与 UI 页面及 `content` 脚本之间的有效通信。
*   **内容脚本注入和隔离:** `recorder.js` 和 `player.js` 作为内容脚本，需要确保正确注入到目标页面，并且其作用域与页面脚本隔离，同时能够与 `service-worker` 通信。
*   **CSS 优先级冲突导致的界面阻塞:** 管理面板界面出现灰色蒙版且无法交互的问题，经过深入分析，发现是 `options/options.html` 中 `.hidden` 类的 `display: none;` 样式被 `.modal-overlay` 的 `display: flex;` 样式覆盖，导致模态框覆盖层始终可见。通过为 `.hidden` 类的 `display: none;` 添加 `!important` 标志，强制其优先级，最终解决了界面阻塞问题。
*   **`content/recorder.js` 中的 `SyntaxError` 修复:** 在开发过程中，`content/recorder.js` 文件中出现 `Uncaught SyntaxError: Invalid or unexpected token` 错误，主要原因是调试时添加的 `console.log` 语句中的模板字符串转义问题。通过仔细检查和修正，确保了代码的语法正确性。
*   **录制模块中的点击干扰与视觉反馈优化:** 初始实现的视觉反馈（直接修改元素边框）导致点击事件失效。通过将点击反馈和悬停反馈统一为使用独立的 `highlightBox` 元素，并移除直接修改元素样式的功能，彻底解决了点击干扰问题，同时提供了更稳定、非侵入式的视觉反馈。
*   **输入框内容无法记录问题修复:** 录制模块未能有效捕获文本输入。通过将输入事件的监听从 `input` 事件优化为更可靠的 `change` 事件，确保了用户在输入框完成输入（如失去焦点或按回车）时，其最终值能够被准确记录。**本次迭代中，进一步增强了 `content/recorder.js` 中的 `keydown` 事件处理器，确保当用户在输入框内按下回车键时，其当前输入值也能被准确捕获和记录，解决了此前遗漏的输入场景。**
*   **回放功能未完全执行问题修复:** 回放引擎未能正确处理所有录制到的事件类型，特别是 `change` 事件和 `scroll` 事件。通过在 `content/player.js` 中新增对 `change` 事件的逻辑处理，并修正 `scroll` 事件的 `x` 和 `y` 坐标访问方式，确保了所有录制步骤都能被正确识别和执行。**本次迭代中，进一步增强了 `service-worker.js` 中的回放逻辑，引入了对动态页面导航和加载时间的处理能力。通过预判导航步骤并使用 `chrome.webNavigation.onCompleted` 监听器，确保在页面跳转后能够重新注入 `player.js` 并恢复回放流程，有效解决了回放过程中因页面刷新导致脚本中断的问题，从而解决了回放功能不完整和执行失败的问题。**

## 6. 下一步计划

1.  **加载扩展进行初步测试:** 将当前生成的代码加载到 Chrome 浏览器中作为未打包的扩展程序，验证其所有已修复和增强的功能，包括：
    *   弹出窗口的录制/停止按钮是否正常工作，且无 UI 阻塞。
    *   选项页面是否能正确加载，并显示脚本管理界面，且无 UI 阻塞。
    *   尝试录制简单的点击、输入和滚动操作，并验证视觉反馈是否正常。
    *   尝试回放录制好的脚本，验证所有步骤是否能完整执行。
    *   方法1：开发者模式安装（推荐）
        1. **下载扩展文件**
        - 下载整个文件夹

        2. **打开Chrome扩展页面**
        - 在Chrome地址栏输入：`chrome://extensions/`

        3. **启用开发者模式**
        - 在页面右上角打开"开发者模式"开关

        4. **加载扩展**
        - 点击"加载已解压的扩展程序"
        - 选择文件夹

        5. **完成安装**
        - 扩展图标会出现在浏览器工具栏中
3.  **逐步完善功能:** 按照 `jishu.md` 的详细需求，继续实现代码中剩余的 `TODO` 部分，特别是：
    *   完善定时任务的周期性设置（每周、每月）。
    *   实现完整的脚本编辑和动态变量输入 UI。
    *   实现高级错误处理的重试/跳过逻辑。
    *   完善下载文件的匹配逻辑和日志记录。
    *   实现任务日志的显示、过滤、导出和清除。
    *   实现全局设置的加载与保存。
    *   完善快捷键的配置和绑定逻辑（目前基础功能已实现，需进一步完善UI和用户体验）。
4.  **持续优化和测试:** 对已实现的功能进行详细测试和优化，提升用户体验和稳定性。
5.  **文档更新:** 在每次功能完善和代码修改后，及时更新 `README.md` 和其他相关文档。
